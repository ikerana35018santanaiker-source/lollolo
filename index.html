<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CarKiller</title>
  <style>
    html,body { height:100%; margin:0; overflow:hidden; font-family: Arial, Helvetica, sans-serif }
    #ui { position: absolute; left: 12px; top: 12px; color:#fff; z-index:10; text-shadow:0 1px 3px rgba(0,0,0,.7) }
    #info { background: rgba(0,0,0,0.4); padding:10px; border-radius:8px }
    #start { display:inline-block; margin-top:8px; padding:8px 12px; background:#1e90ff; color:#fff; border-radius:6px; cursor:pointer }
    #canvas-container { width:100%; height:100vh }
    .hint { font-size:13px; opacity:.9 }
  </style>
</head>
<body>
  <div id="canvas-container"></div>
  <div id="ui">
    <div id="info">
      <div><strong>Fortnite-like (demo)</strong></div>
      <div class="hint">Controles: clic para bloquear puntero, WASD para moverte, mouse para mirar</div>
      <div style="margin-top:8px">Vida: <span id="health">100</span> &nbsp;|&nbsp; Enemigos: <span id="enemyCount">0</span></div>
      <div id="start">Iniciar demo</div>
      <div style="margin-top:6px;font-size:12px;opacity:.8">Coloca <code>Coche.glb</code> en la misma carpeta que este HTML y sirve mediante HTTP</div>
    </div>
  </div>

  <script type="module">
    import * as THREE from 'https://unpkg.com/three@0.152.2/build/three.module.js';
    import { GLTFLoader } from 'https://unpkg.com/three@0.152.2/examples/jsm/loaders/GLTFLoader.js';
    import { PointerLockControls } from 'https://unpkg.com/three@0.152.2/examples/jsm/controls/PointerLockControls.js';

    const container = document.getElementById('canvas-container');
    const startBtn = document.getElementById('start');
    const healthEl = document.getElementById('health');
    const enemyCountEl = document.getElementById('enemyCount');

    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x87ceeb);
    scene.fog = new THREE.Fog(0x87ceeb, 10, 80);

    const camera = new THREE.PerspectiveCamera(75, innerWidth/innerHeight, 0.1, 1000);
    camera.position.set(0, 1.6, 5);

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(innerWidth, innerHeight);
    renderer.shadowMap.enabled = true;
    renderer.outputEncoding = THREE.sRGBEncoding;
    renderer.toneMapping = THREE.ACESFilmicToneMapping;
    renderer.toneMappingExposure = 1.0;
    container.appendChild(renderer.domElement);

    // LUCES
    const hemi = new THREE.HemisphereLight(0xffffff, 0x444444, 1.0);
    scene.add(hemi);
    const dir = new THREE.DirectionalLight(0xffffff, 1.5);
    dir.position.set(5, 10, 7);
    dir.castShadow = true;
    scene.add(dir);

    // SUELO
    const groundMat = new THREE.MeshStandardMaterial({ color: 0x228B22 });
    const ground = new THREE.Mesh(new THREE.PlaneGeometry(200,200), groundMat);
    ground.rotation.x = -Math.PI/2;
    ground.receiveShadow = true;
    scene.add(ground);

    const controls = new PointerLockControls(camera, renderer.domElement);
    let move = { forward:false, back:false, left:false, right:false };
    let velocity = new THREE.Vector3();
    const speed = 6;

    document.addEventListener('keydown', (e) => { if(e.code==='KeyW') move.forward=true; if(e.code==='KeyS') move.back=true; if(e.code==='KeyA') move.left=true; if(e.code==='KeyD') move.right=true; });
    document.addEventListener('keyup', (e) => { if(e.code==='KeyW') move.forward=false; if(e.code==='KeyS') move.back=false; if(e.code==='KeyA') move.left=false; if(e.code==='KeyD') move.right=false; });

    startBtn.addEventListener('click', ()=>controls.lock());
    controls.addEventListener('lock', ()=>startBtn.style.display='none');
    controls.addEventListener('unlock', ()=>startBtn.style.display='inline-block');

    const gltfLoader = new GLTFLoader();

    let playerModel = null;
    const enemies = [];
    const mixers = [];
    let playerHealth = 100;

    gltfLoader.load('Coche.glb', (gltf)=>{
      const root = gltf.scene;
      root.traverse((c)=>{ if(c.isMesh){ c.castShadow=true; c.receiveShadow=true; c.material.side=THREE.DoubleSide; } });
      root.scale.setScalar(1);
      root.position.set(0,0,0);

      playerModel = root.clone();
      scene.add(playerModel);

      if(gltf.animations.length){ const mixer=new THREE.AnimationMixer(playerModel); mixers.push(mixer); gltf.animations.forEach(a=>mixer.clipAction(a).play()); }

      // enemigos
      const enemyCount = 6;
      for(let i=0;i<enemyCount;i++){
        const e = root.clone();
        const angle = Math.random()*Math.PI*2;
        const dist = 8+Math.random()*12;
        e.position.set(Math.cos(angle)*dist,0,Math.sin(angle)*dist);
        scene.add(e);
        const enemy={mesh:e,speed:1.5+Math.random()*1.5};
        enemies.push(enemy);

        if(gltf.animations.length){ const m=new THREE.AnimationMixer(e); mixers.push(m); gltf.animations.forEach(a=>m.clipAction(a).play()); }
      }
      enemyCountEl.textContent = enemies.length;
    }, undefined, (err)=>{ console.error(err); alert('No se pudo cargar Coche.glb. Usa HTTP/HTTPS y ponlo en la misma carpeta.'); });

    const clock = new THREE.Clock();

    function animate(){
      requestAnimationFrame(animate);
      const dt=clock.getDelta();
      mixers.forEach(m=>m.update(dt));

      const dir = new THREE.Vector3();
      const forward = new THREE.Vector3(); camera.getWorldDirection(forward); forward.y=0; forward.normalize();
      const right = new THREE.Vector3().crossVectors(new THREE.Vector3(0,1,0), forward).normalize();
      dir.set(0,0,0);
      if(move.forward) dir.add(forward);
      if(move.back) dir.sub(forward);
      if(move.left) dir.add(right);
      if(move.right) dir.sub(right);
      if(dir.length()>0) dir.normalize();
      velocity.copy(dir).multiplyScalar(speed*dt);
      controls.getObject().position.add(velocity);

      if(playerModel){
        playerModel.position.copy(controls.getObject().position);
        const camDir=new THREE.Vector3(); camera.getWorldDirection(camDir); camDir.y=0; camDir.normalize();
        if(camDir.length()>0.001) playerModel.lookAt(playerModel.position.clone().add(camDir));
      }

      enemies.forEach((e)=>{
        const toPlayer=new THREE.Vector3().subVectors(controls.getObject().position,e.mesh.position);
        const dist=toPlayer.length();
        if(dist>0.1){ toPlayer.normalize(); e.mesh.position.addScaledVector(toPlayer,e.speed*dt); e.mesh.lookAt(controls.getObject().position.x,e.mesh.position.y,controls.getObject().position.z); }
        const hitDistance=1.2; if(dist<hitDistance){ playerHealth-=10*dt; if(playerHealth<0) playerHealth=0; healthEl.textContent=Math.round(playerHealth); }
      });

      renderer.render(scene,camera);
    }

    window.addEventListener('resize', ()=>{ camera.aspect=innerWidth/innerHeight; camera.updateProjectionMatrix(); renderer.setSize(innerWidth,innerHeight); });

    const playerObj=controls.getObject();
    playerObj.position.set(0,1.6,0);
    scene.add(playerObj);

    function clampPlayerToGround(){ playerObj.position.y=1.6; if(playerModel) playerModel.position.y=0; }

    startBtn.addEventListener('click', ()=>{ camera.position.copy(playerObj.position); animate(); setInterval(clampPlayerToGround,100); });
  </script>
</body>
</html>
