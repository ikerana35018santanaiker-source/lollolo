<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CarKiller</title>
<style>
  html,body { height:100%; margin:0; overflow:hidden; font-family: Arial, Helvetica, sans-serif; background:#000; }
  #canvas-container { width:100%; height:100vh; display:none; }
  #menu { position:absolute; top:0; left:0; width:100%; height:100%; display:flex; justify-content:center; align-items:center; background:#111; color:#fff; flex-direction:column; }
  #menu h1 { font-size:48px; margin-bottom:20px; }
  #menu button { padding:12px 24px; font-size:18px; cursor:pointer; border:none; border-radius:8px; background:#1e90ff; color:#fff; }
</style>
</head>
<body>
  <div id="menu">
    <h1>Fortnite-like Demo</h1>
    <button id="startGame">Iniciar Juego</button>
  </div>
  <div id="canvas-container"></div>

<script type="module">
import * as THREE from 'https://unpkg.com/three@0.152.2/build/three.module.js';
import { GLTFLoader } from 'https://unpkg.com/three@0.152.2/examples/jsm/loaders/GLTFLoader.js';
import { PointerLockControls } from 'https://unpkg.com/three@0.152.2/examples/jsm/controls/PointerLockControls.js';

const menu = document.getElementById('menu');
const startBtn = document.getElementById('startGame');
const container = document.getElementById('canvas-container');

startBtn.addEventListener('click', ()=>{
  menu.style.display='none';
  container.style.display='block';
  initGame();
});

function initGame(){
  const scene = new THREE.Scene();
  scene.background = new THREE.Color(0x87ceeb);
  scene.fog = new THREE.Fog(0x87ceeb, 10, 80);

  const camera = new THREE.PerspectiveCamera(75, innerWidth/innerHeight, 0.1, 1000);
  camera.position.set(0, 1.6, 5);

  const renderer = new THREE.WebGLRenderer({antialias:true});
  renderer.setSize(innerWidth, innerHeight);
  renderer.shadowMap.enabled = true;
  renderer.outputEncoding = THREE.sRGBEncoding;
  renderer.toneMapping = THREE.ACESFilmicToneMapping;
  renderer.toneMappingExposure = 1.0;
  container.appendChild(renderer.domElement);

  const hemi = new THREE.HemisphereLight(0xffffff,0x444444,1.0); scene.add(hemi);
  const dir = new THREE.DirectionalLight(0xffffff,1.5); dir.position.set(5,10,7); dir.castShadow=true; scene.add(dir);

  const groundMat = new THREE.MeshStandardMaterial({color:0x228B22});
  const ground = new THREE.Mesh(new THREE.PlaneGeometry(200,200), groundMat);
  ground.rotation.x = -Math.PI/2; ground.receiveShadow=true; scene.add(ground);

  const controls = new PointerLockControls(camera, renderer.domElement);
  document.addEventListener('click', ()=>controls.lock());

  let move={forward:false,back:false,left:false,right:false};
  let velocity=new THREE.Vector3(); const speed=6;
  document.addEventListener('keydown',e=>{ if(e.code==='KeyW') move.forward=true; if(e.code==='KeyS') move.back=true; if(e.code==='KeyA') move.left=true; if(e.code==='KeyD') move.right=true; });
  document.addEventListener('keyup',e=>{ if(e.code==='KeyW') move.forward=false; if(e.code==='KeyS') move.back=false; if(e.code==='KeyA') move.left=false; if(e.code==='KeyD') move.right=false; });

  const gltfLoader = new GLTFLoader();
  let playerModel=null, enemies=[], mixers=[], playerHealth=100;

  gltfLoader.load('Coche.glb', (gltf)=>{
    const root=gltf.scene;
    root.traverse(c=>{ if(c.isMesh){ c.castShadow=true; c.receiveShadow=true; c.material.side=THREE.DoubleSide; c.material = new THREE.MeshStandardMaterial({color:0xff0000}); } });
    root.scale.setScalar(1); root.position.set(0,0,0);

    playerModel=root.clone(); scene.add(playerModel);
    if(gltf.animations.length){ const mixer=new THREE.AnimationMixer(playerModel); mixers.push(mixer); gltf.animations.forEach(a=>mixer.clipAction(a).play()); }

    for(let i=0;i<6;i++){
      const e=root.clone();
      const angle=Math.random()*Math.PI*2; const dist=8+Math.random()*12;
      e.position.set(Math.cos(angle)*dist,0,Math.sin(angle)*dist);
      scene.add(e);
      const enemy={mesh:e,speed:1.5+Math.random()*1.5}; enemies.push(enemy);
      if(gltf.animations.length){ const m=new THREE.AnimationMixer(e); mixers.push(m); gltf.animations.forEach(a=>m.clipAction(a).play()); }
    }
  },undefined,(err)=>{ console.error(err); alert('No se pudo cargar Coche.glb. Usa HTTP y ponlo en la misma carpeta.'); });

  const clock=new THREE.Clock();
  const playerObj=controls.getObject(); playerObj.position.set(0,1.6,0); scene.add(playerObj);

  function animate(){
    requestAnimationFrame(animate);
    const dt=clock.getDelta();
    mixers.forEach(m=>m.update(dt));

    const dirVec=new THREE.Vector3();
    const forward=new THREE.Vector3(); camera.getWorldDirection(forward); forward.y=0; forward.normalize();
    const right=new THREE.Vector3().crossVectors(new THREE.Vector3(0,1,0),forward).normalize();
    dirVec.set(0,0,0);
    if(move.forward) dirVec.add(forward); if(move.back) dirVec.sub(forward);
    if(move.left) dirVec.add(right); if(move.right) dirVec.sub(right);
    if(dirVec.length()>0) dirVec.normalize();
    velocity.copy(dirVec).multiplyScalar(speed*dt); controls.getObject().position.add(velocity);

    if(playerModel){
      playerModel.position.copy(controls.getObject().position);
      const camDir=new THREE.Vector3(); camera.getWorldDirection(camDir); camDir.y=0; camDir.normalize();
      if(camDir.length()>0.001) playerModel.lookAt(playerModel.position.clone().add(camDir));
    }

    enemies.forEach(e=>{
      const toPlayer=new THREE.Vector3().subVectors(controls.getObject().position,e.mesh.position);
      const dist=toPlayer.length();
      if(dist>0.1){ toPlayer.normalize(); e.mesh.position.addScaledVector(toPlayer,e.speed*dt); e.mesh.lookAt(controls.getObject().position.x,e.mesh.position.y,controls.getObject().position.z); }
      if(dist<1.2){ playerHealth-=10*dt; if(playerHealth<0) playerHealth=0; }
    });

    renderer.render(scene,camera);
  }

  animate();
  window.addEventListener('resize',()=>{ camera.aspect=innerWidth/innerHeight; camera.updateProjectionMatrix(); renderer.setSize(innerWidth,innerHeight); });
}
</script>
</body>
</html>
